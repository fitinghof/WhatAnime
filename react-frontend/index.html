<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>What anime is this from?</title>
  <link rel="stylesheet" href="{{url_for('static', filename='styles.css')}}">
  <script>
    function updateCurrentlyPlaying() {
      fetch("http://127.0.0.1:8000/update", {
        credentials: "include",
      })
        .then(response =>
          response.json()
        )
        .then(data => {
          console.log(data)
          console.log("status " + data.status)
          if (data.status == "new_song") {
            console.log("status == new_song");

            document.getElementById("song_title").innerText = data.songinfo.name;
            document.getElementById("artists").innerText = data.songinfo.artists.map(artist => artist.name).join(", ");
            document.getElementById("album_cover").src = data.songinfo.album.images[0].url;

            const listContainer = document.getElementById("animes");
            listContainer.innerHTML = "";
            if (data.animes.length == 0) {
              return document.getElementById("matches").innerText = "No matches"
            }
            document.getElementById("matches").innerText = `${data.certainty}% match`

            data.animes.forEach((anime) => {

              // Create the anime item container
              const animeItem = document.createElement("div");
              animeItem.classList.add("anime-item");

              // Create the anime info container
              const animeInfo = document.createElement("div");
              animeInfo.classList.add("anime-info");

              // Create the anime title
              const animeTitleElement = document.createElement("div");
              animeTitleElement.classList.add("anime-title");
              animeTitleElement.textContent = anime.animeENName || "Unknown Anime";  // Fallback if missing
              animeInfo.appendChild(animeTitleElement);

              // Create the season information
              if (anime.animeCategory != "Season" && anime.animeCategory != "TV") {
                const animeSeasonElement = document.createElement("div");
                animeSeasonElement.classList.add("anime-season");
                animeSeasonElement.textContent = `${anime.animeCategory || "Unknown"}`;  // Fallback if missing
                animeInfo.appendChild(animeSeasonElement);
              }
              // create the opening number information
              const openingNumberElement = document.createElement("div");
              openingNumberElement.classList.add("anime-opening");
              openingNumberElement.textContent = `${anime.songType}`;  // Fallback if missing
              animeInfo.appendChild(openingNumberElement);

              // Create the type information
              const animeTypeElement = document.createElement("div");
              animeTypeElement.classList.add("anime-type");
              animeTypeElement.textContent = `Type: ${anime.animeType || "Unknown"}`;  // Fallback if missing
              animeInfo.appendChild(animeTypeElement);


              // Create a list of links (MAL, ANN, AniDB, Kitsu)
              const linksList = document.createElement("ul");
              if (anime.linked_ids) {
                // Create a container for the links
                const linksContainer = document.createElement("div");
                linksContainer.classList.add("anime-links"); // Ensure the correct CSS class is applied

                // MAL link
                if (anime.linked_ids.myanimelist) {
                  const malLink = document.createElement("a");
                  malLink.href = `https://myanimelist.net/anime/${anime.linked_ids.myanimelist}`;
                  malLink.textContent = "MAL";
                  malLink.target = "_blank"; // Open in new tab
                  linksContainer.appendChild(malLink);
                }

                // ANN link
                if (anime.linked_ids.anilist) {
                  const annLink = document.createElement("a");
                  annLink.href = `https://anilist.co/anime/${anime.linked_ids.anilist}`;
                  annLink.textContent = "Anilist";
                  annLink.target = "_blank"; // Open in new tab
                  linksContainer.appendChild(annLink);
                }

                // AniDB link
                if (anime.linked_ids.anidb) {
                  const anidbLink = document.createElement("a");
                  anidbLink.href = `https://anidb.net/anime/${anime.linked_ids.anidb}`;
                  anidbLink.textContent = "AniDB";
                  anidbLink.target = "_blank"; // Open in new tab
                  linksContainer.appendChild(anidbLink);
                }

                // Kitsu link
                if (anime.linked_ids.kitsu) {
                  const kitsuLink = document.createElement("a");
                  kitsuLink.href = `https://kitsu.io/anime/${anime.linked_ids.kitsu}`;
                  kitsuLink.textContent = "Kitsu";
                  kitsuLink.target = "_blank"; // Open in new tab
                  linksContainer.appendChild(kitsuLink);
                }

                // Append the links container to the anime info section
                animeInfo.appendChild(linksContainer);
              }

              // Append title, season, and type to the anime info container

              // Append the anime info container to the anime item
              animeItem.appendChild(animeInfo);

              // Find the anime list container
              const listContainer = document.querySelector(".anime-list");

              // Append the anime item to the anime list container
              listContainer.appendChild(animeItem);
            });

          }
          else if (data.status == "not_playing") {
            document.getElementById("song_title").innerText = "Not playing anything";
            document.getElementById("artists").innerText = "";
            document.getElementById("album_cover").src = "{{url_for('static', filename='slime.png')}}";
            document.getElementById("animes") = "";
            document.getElementById("matches").innerText = "No matches"
          }
          else if (data.status == "no_updates") {
            // Do nothing
          }
          else if (data == "\"LoginRequired\"") {
            window.location.href = "http://127.0.0.1:8000/login";
          }
          else if (data.status == "unapproved_user") {
            document.getElementById("song_title").innerText = "Un-approved user";
            document.getElementById("artists").innerText = "";
            document.getElementById("album_cover").src = "{{url_for('static', filename='slime.png')}}";
            document.getElementById("animes") = "";
            document.getElementById("matches").innerText = "Ask Simon for approval"
          }
          else {

          }
        }).catch(err => console.error(err));
    }
    updateCurrentlyPlaying();
    setInterval(updateCurrentlyPlaying, 5000); // Poll every 5 seconds
  </script>
</head>

<body>
  <div class="now-playing-container">
    <div class="now-playing">
      <img src="" alt="Album Cover" class="album-art" id="album_cover">
      <div class="song-info">
        <div class="song-title" id="song_title">Song Name</div>
        <div class="artist-name" id="artists">Artist Name</div>
      </div>
    </div>
  </div>

  <!-- Separator and Info Section -->
  <div class="separator" id="matches"></div>

  <!-- Anime List -->
  <div class="anime-list" id="animes"></div>
</body>

</html>